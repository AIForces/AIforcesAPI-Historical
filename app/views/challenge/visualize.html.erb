<script>
    let my_log;
    let current_frame = 0;
    let is_playing = 0;
    let timer_id;
    let n, m;

    function update() {
        if (is_playing) {
            timer_id = setInterval(to_next_frame, 100);
            $("#play_button").html("<i class=\"fas fa-pause\"></i>")
        } else {
            $("#play_button").html("<i class=\"fas fa-play\">");
            clearInterval(timer_id)
        }
    }
    $(document).ready(function() {
        $.getJSON("<%= "#{challenge_log_url}?id=#{@id}&format=json"%>", function (data) {
            my_log = data;
            n = my_log[current_frame]["board"].length;
            m = my_log[current_frame]["board"][0].length;

            for(let i = 0; i < n; i++) {
                for (let j = 0; j < m; j++) {
                    styles = 'style="height: ' + (100.0 / n).toString() + '%; width:' + (100.0 / m).toString() + '%"';
                    $(".board").append('<div class="board_basic_cell" ' + styles + '><div id="cell_' + i.toString() + '_' + j.toString()+ '"></div></div>');
                }
            }

            redraw();
            $("#play_button").click(function () {
                is_playing ^= 1;
                update()
            });

            $("#repeat_button").click(function () {
                current_frame = 0;
                is_playing = 0;
                update()
                redraw()
            })
        });
    });

    function to_next_frame() {
        if (current_frame + 1 == my_log.length) {
            clearInterval(timer_id);
            return;
        }
        current_frame++;
        redraw();
    }

    function redraw() {
        class_mapper = {
            0: "empty",
            1: "red",
            2: "red_tail",
            3: "red_tail",
            4: "red_tail",
            5: "red_tail",
            6: "red_tail",
            7: "red_tail",
            8: "red_tail",
            9: "red_tail",
            10: "red_tail",
            11: "red_tail",
            12: "red_tail",
            13: "blue",
            14: "blue_tail",
            15: "blue_tail",
            16: "blue_tail",
            17: "blue_tail",
            18: "blue_tail",
            19: "blue_tail",
            20: "blue_tail",
            21: "blue_tail",
            22: "blue_tail",
            23: "blue_tail",
            24: "blue_tail",
            25: "",
            26: "",
            27: "",
            28: "",
        };
        for(let i = 0; i < n; i++) {
            for (let j = 0; j < m; j++) {
                let cur_class = class_mapper[my_log[current_frame]["board"][i][j]];
                $("#cell_" + i + "_" + j).attr("class", "square " + cur_class)
            }
        }
        $("#points1").html(my_log[current_frame]["points"][0]);
        $("#points2").html(my_log[current_frame]["points"][1]);
    }
</script>

<div class="columns">
  <div class="column">
    <div class="section">
      <div class="notification is-info">
        <h2 class="title is-5">
          Управление визуализацией
        </h2>
        <button id="play_button" class="button"><i class="fas fa-play"></i></button>
        <button id="repeat_button" class="button"><i class="fas fa-redo"></i></button>
        <br/>
        <br/>
        <h2 class="title is-5">
          Текущий счёт
        </h2>
        <table class="table is-fullwidth is-bordered is-hoverable">
          <tbody>
          <tr>
            <td>Игрок 1</td>
            <td id="points1">0</td>
          </tr>
          <tr>
            <td>Игрок 2</td>
            <td id="points2">0</td>
          </tr>
          </tbody>
        </table>
        <h2 class="title is-5">
          Информация о дуэли
        </h2>
        <table class="table is-fullwidth is-bordered is-hoverable">
          <tbody>
            <tr>
              <td>ID</td>
              <td><%= @id %></td>
            </tr>
            <tr>
              <td>Игрок I</td>
              <td><%= @cur_item[:player1] %></td>
            </tr>
            <tr>
              <td>Игрок II</td>
              <td><%= @cur_item[:player2] %></td>
            </tr>
            <tr>
              <td>Победитель</td>
              <td><%= @cur_item[:winner] %></td>
            </tr>
            <tr>
              <td>Вердикт I игрока</td>
              <td><%= @cur_item[:player1_verdict] %></td>
            </tr>
            <tr>
              <td>Вердикт II игрока</td>
              <td><%= @cur_item[:player2_verdict] %></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <div class="column is-three-fifths">
    <div class="section">
      <div class="board">
      </div>
    </div>
  </div>
</div>